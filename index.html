<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Legal Timesheet - 律師工時追蹤器</title>
    
    <!-- 1. 載入 Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- 2. 載入 React 和 ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- 3. 載入 Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- 4. 載入 Firebase -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

    <style>
        body { font-family: system-ui, -apple-system, sans-serif; }
    </style>
</head>
<body class="bg-slate-50 text-slate-800">

    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;
        
        // --- 內建圖示 ---
        const IconBase = ({ children, className, ...props }) => (<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className} {...props}>{children}</svg>);
        const Play = (props) => <IconBase {...props}><polygon points="5 3 19 12 5 21 5 3"></polygon></IconBase>;
        const Square = (props) => <IconBase {...props}><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect></IconBase>;
        const Pause = (props) => <IconBase {...props}><rect x="6" y="4" width="4" height="16"></rect><rect x="14" y="4" width="4" height="16"></rect></IconBase>;
        const Plus = (props) => <IconBase {...props}><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></IconBase>;
        const Trash2 = (props) => <IconBase {...props}><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path><line x1="10" y1="11" x2="10" y2="17"></line><line x1="14" y1="11" x2="14" y2="17"></line></IconBase>;
        const Download = (props) => <IconBase {...props}><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" y1="15" x2="12" y2="3"></line></IconBase>;
        const Copy = (props) => <IconBase {...props}><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></IconBase>;
        const Briefcase = (props) => <IconBase {...props}><rect x="2" y="7" width="20" height="14" rx="2" ry="2"></rect><path d="M16 21V5a2 2 0 0 0-2-2h-4a2 2 0 0 0-2 2v16"></path></IconBase>;
        const FileText = (props) => <IconBase {...props}><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line><polyline points="10 9 9 9 8 9"></polyline></IconBase>;
        const User = (props) => <IconBase {...props}><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle></IconBase>;
        const Tag = (props) => <IconBase {...props}><path d="M20.59 13.41l-7.17 7.17a2 2 0 0 1-2.83 0L2 12V2h10l8.59 8.59a2 2 0 0 1 0 2.82z"></path><line x1="7" y1="7" x2="7.01" y2="7"></line></IconBase>;
        const ListTodo = (props) => <IconBase {...props}><rect x="3" y="6" width="6" height="6" rx="1"></rect><path d="M14 6h7"></path><path d="M14 10h7"></path><path d="M3 16h18"></path></IconBase>;
        const CheckSquare = (props) => <IconBase {...props}><polyline points="9 11 12 14 22 4"></polyline><path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"></path></IconBase>;
        const History = (props) => <IconBase {...props}><path d="M3 3v5h5"></path><path d="M3.05 13A9 9 0 1 0 6 2.53"></path><polyline points="12 6 12 12 16 14"></polyline></IconBase>;
        const Save = (props) => <IconBase {...props}><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"></path><polyline points="17 21 17 13 7 13 7 21"></polyline><polyline points="7 3 7 8 15 8"></polyline></IconBase>;
        const Upload = (props) => <IconBase {...props}><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="17 8 12 3 7 8"></polyline><line x1="12" y1="3" x2="12" y2="15"></line></IconBase>;
        const Pencil = (props) => <IconBase {...props}><path d="M17 3a2.828 2.828 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z"></path></IconBase>;
        const X = (props) => <IconBase {...props}><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></IconBase>;
        const Settings = (props) => <IconBase {...props}><circle cx="12" cy="12" r="3"></circle><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path></IconBase>;
        const CloudLightning = (props) => <IconBase {...props}><path d="M19 16.9A5 5 0 0 0 18 7h-1.26a8 8 0 1 0-11.62 9"></path><polyline points="13 11 9 17 15 17 11 23"></polyline></IconBase>;
        const Calendar = (props) => <IconBase {...props}><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></IconBase>;
        const Eye = (props) => <IconBase {...props}><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path><circle cx="12" cy="12" r="3"></circle></IconBase>;
        const EyeOff = (props) => <IconBase {...props}><path d="M17.94 17.94A10.07 10.07 0 0 1 12 20c-7 0-11-8-11-8a18.45 18.45 0 0 1 5.06-5.94M9.9 4.24A9.12 9.12 0 0 1 12 4c7 0 11 8 11 8a18.5 18.5 0 0 1-2.16 3.19m-6.72-1.07a3 3 0 1 1-4.24-4.24"></path><line x1="1" y1="1" x2="23" y2="23"></line></IconBase>;
        const Database = (props) => <IconBase {...props}><ellipse cx="12" cy="5" rx="9" ry="3"></ellipse><path d="M21 12c0 1.66-4 3-9 3s-9-1.34-9-3"></path><path d="M3 5v14c0 1.66 4 3 9 3s 9-1.34 9-3V5"></path></IconBase>;
        const RefreshCw = (props) => <IconBase {...props}><polyline points="23 4 23 10 17 10"></polyline><polyline points="1 20 1 14 7 14"></polyline><path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"></path></IconBase>;

        // --- 核心程式碼 ---

        const LegalTimesheet = () => {
            // --- 狀態管理 ---
            const [entries, setEntries] = useState(() => {
                const saved = localStorage.getItem('legal_timesheet_entries_v2');
                return saved ? JSON.parse(saved) : [];
            });
            const [todos, setTodos] = useState(() => {
                const saved = localStorage.getItem('legal_timesheet_todos_v2');
                return saved ? JSON.parse(saved) : [];
            });
            
            const [firebaseConfig, setFirebaseConfig] = useState(() => localStorage.getItem('legal_timesheet_fb_config') || '');
            const [syncId, setSyncId] = useState(() => localStorage.getItem('legal_timesheet_sync_id') || '');
            const [isCloudConnected, setIsCloudConnected] = useState(false);
            const [cloudStatus, setCloudStatus] = useState('offline'); 
            const [cloudErrorMsg, setCloudErrorMsg] = useState('');

            // 其他狀態
            const [activeEntry, setActiveEntry] = useState(null);
            const [timer, setTimer] = useState(0);
            const [timerStatus, setTimerStatus] = useState('idle'); 
            const startTimeRef = useRef(0);       
            const accumulatedTimeRef = useRef(0); 
            const timerIntervalRef = useRef(null);
            
            // 表單輸入狀態
            const todayStr = new Date().toLocaleDateString('zh-TW', { year: 'numeric', month: '2-digit', day: '2-digit' }).replace(/\//g, '-');
            const [date, setDate] = useState(todayStr); // 新增日期狀態
            
            const [supervisor, setSupervisor] = useState('');
            const [clientCode, setClientCode] = useState('');
            const [sortOfWork, setSortOfWork] = useState(''); 
            const [description, setDescription] = useState(''); 
            const [manualDuration, setManualDuration] = useState('');
            const [editingId, setEditingId] = useState(null);
            const [resumingEntryId, setResumingEntryId] = useState(null); 
            const [todoInput, setTodoInput] = useState('');
            const [todoClient, setTodoClient] = useState('');
            const [activeTodoId, setActiveTodoId] = useState(null);
            const [showCompleted, setShowCompleted] = useState(true);
            const [editingTodoId, setEditingTodoId] = useState(null);
            const [editTodoText, setEditTodoText] = useState('');
            const [editTodoClient, setEditTodoClient] = useState('');
            const fileInputRef = useRef(null);
            const [isSettingsOpen, setIsSettingsOpen] = useState(false);
            const [webhookUrl, setWebhookUrl] = useState(() => localStorage.getItem('legal_timesheet_webhook_url') || '');
            const [isSyncing, setIsSyncing] = useState(false);
            
            const [exportStartDate, setExportStartDate] = useState(todayStr);
            const [exportEndDate, setExportEndDate] = useState(todayStr);

            const quickDescriptions = ["Drafting legal opinion", "Legal research on...", "Meeting with client", "Teleconference with...", "Reviewing contract", "Replying to emails"];

            useEffect(() => { localStorage.setItem('legal_timesheet_entries_v2', JSON.stringify(entries)); }, [entries]);
            useEffect(() => { localStorage.setItem('legal_timesheet_todos_v2', JSON.stringify(todos)); }, [todos]);
            useEffect(() => { localStorage.setItem('legal_timesheet_webhook_url', webhookUrl); }, [webhookUrl]);
            useEffect(() => { localStorage.setItem('legal_timesheet_fb_config', firebaseConfig); }, [firebaseConfig]);
            useEffect(() => { localStorage.setItem('legal_timesheet_sync_id', syncId); }, [syncId]);

            // --- Firebase Cloud Sync Logic ---
            const parseFirebaseConfig = (input) => {
                if (!input) return null;
                const trimmed = input.trim();
                try {
                    return JSON.parse(trimmed);
                } catch (e) {
                    try {
                        let cleaned = input.replace(/^(const|var|let)\s+\w+\s*=\s*/, '').trim();
                        if (cleaned.endsWith(';')) cleaned = cleaned.slice(0, -1);
                        const first = cleaned.indexOf('{');
                        const last = cleaned.lastIndexOf('}');
                        if (first !== -1 && last !== -1) {
                            const objStr = cleaned.substring(first, last + 1);
                            return new Function('return ' + objStr)();
                        }
                        throw new Error("找不到 { } 設定區塊");
                    } catch (e2) {
                        console.error("Config parse failed", e2);
                        return null;
                    }
                }
            };

            useEffect(() => {
                let unsubscribe = null;
                const initFirebase = async () => {
                    if (!firebaseConfig || !syncId) return;
                    try {
                        setCloudStatus('connecting');
                        setCloudErrorMsg('');
                        const config = parseFirebaseConfig(firebaseConfig);
                        if (!config) {
                            setCloudStatus('error');
                            setCloudErrorMsg('設定格式錯誤，請檢查複製內容');
                            return;
                        }
                        if (firebase.apps.length) { await firebase.app().delete(); }
                        firebase.initializeApp(config);
                        await firebase.auth().signInAnonymously();
                        const db = firebase.firestore();
                        const docRef = db.collection('timesheets').doc(syncId);
                        unsubscribe = docRef.onSnapshot((doc) => {
                            setCloudStatus('connected');
                            setIsCloudConnected(true);
                            if (doc.exists) {
                                const data = doc.data();
                                if (JSON.stringify(data.entries) !== JSON.stringify(entries)) { setEntries(data.entries || []); }
                                if (JSON.stringify(data.todos) !== JSON.stringify(todos)) { setTodos(data.todos || []); }
                            }
                        }, (error) => {
                            console.error("Sync error:", error);
                            setCloudStatus('error');
                            let msg = error.message;
                            if (error.code === 'permission-denied') msg = '權限不足 (請檢查 Sync ID 或 Firestore Rules)';
                            if (error.code === 'unavailable') msg = '網路連線問題 (Firestore 無法連線)';
                            setCloudErrorMsg(msg);
                        });
                    } catch (e) {
                        console.error("Firebase init error:", e);
                        setCloudStatus('error');
                        let msg = e.message;
                        if (e.code === 'auth/configuration-not-found' || e.code === 'auth/operation-not-allowed' || e.code === 'auth/admin-restricted-operation') {
                            msg = "請至 Firebase Console 開啟 Authentication -> Sign-in method -> 啟用 Anonymous (匿名登入)";
                        }
                        setCloudErrorMsg(msg);
                    }
                };
                if (firebaseConfig && syncId) { initFirebase(); } else { setCloudStatus('offline'); }
                return () => { if (unsubscribe) unsubscribe(); };
            }, [firebaseConfig, syncId]);

            useEffect(() => {
                if (!isCloudConnected || !syncId || !firebaseConfig || cloudStatus !== 'connected') return;
                const saveToCloud = setTimeout(async () => {
                    try {
                        const db = firebase.firestore();
                        await db.collection('timesheets').doc(syncId).set({ entries, todos, updatedAt: new Date().toISOString() });
                    } catch (e) { console.error("Write to cloud error:", e); }
                }, 2000);
                return () => clearTimeout(saveToCloud);
            }, [entries, todos, isCloudConnected, syncId, firebaseConfig, cloudStatus]);

            // --- 計時器與操作邏輯 ---
            useEffect(() => {
                if (timerStatus === 'running') {
                    timerIntervalRef.current = setInterval(() => {
                        const now = Date.now();
                        const elapsedMs = accumulatedTimeRef.current + (now - startTimeRef.current);
                        setTimer(Math.floor(elapsedMs / 1000));
                    }, 500);
                } else { clearInterval(timerIntervalRef.current); }
                return () => clearInterval(timerIntervalRef.current);
            }, [timerStatus]);

            const formatTime = (seconds) => {
                if (isNaN(seconds)) seconds = 0;
                const h = Math.floor(seconds / 3600).toString().padStart(2, '0');
                const m = Math.floor((seconds % 3600) / 60).toString().padStart(2, '0');
                const s = Math.floor(seconds % 60).toString().padStart(2, '0');
                return `${h}:${m}:${s}`;
            };

            const calculateBillable = (seconds) => {
                const minutes = Math.ceil(seconds / 60);
                if (minutes === 0) return 0;
                const units = Math.ceil(minutes / 15);
                return (units * 0.25).toFixed(2);
            };

            const startTimer = () => {
                setTimerStatus('running');
                setTimer(0);
                accumulatedTimeRef.current = 0;
                startTimeRef.current = Date.now(); 
                setActiveEntry({ id: Date.now(), startTime: new Date().toISOString(), supervisor, clientCode, sortOfWork, description, date }); // 使用選定日期
            };
            const pauseTimer = () => { setTimerStatus('paused'); accumulatedTimeRef.current += Date.now() - startTimeRef.current; };
            const resumeTimer = () => { setTimerStatus('running'); startTimeRef.current = Date.now(); };
            const stopTimer = () => {
                let finalDurationMs = accumulatedTimeRef.current;
                if (timerStatus === 'running') { finalDurationMs += Date.now() - startTimeRef.current; }
                const durationSeconds = Math.floor(finalDurationMs / 1000);
                setTimerStatus('idle');
                const endTime = new Date().toISOString();
                
                if (resumingEntryId) {
                    setEntries(entries.map(e => {
                        if (e.id === resumingEntryId) {
                            return { ...e, endTime, durationSeconds, billableHours: calculateBillable(durationSeconds), clientCode, sortOfWork, supervisor, description, date }; // 更新日期
                        }
                        return e;
                    }));
                    setResumingEntryId(null);
                } else {
                    const newEntry = { ...activeEntry, endTime, durationSeconds, billableHours: calculateBillable(durationSeconds), date: date, supervisor, clientCode, sortOfWork, description }; // 使用選定日期
                    setEntries([newEntry, ...entries]);
                    if (activeTodoId) { setTodos(prevTodos => prevTodos.map(todo => todo.id === activeTodoId ? { ...todo, accumulatedSeconds: (todo.accumulatedSeconds || 0) + durationSeconds } : todo)); setActiveTodoId(null); }
                }
                setTimer(0); accumulatedTimeRef.current = 0; setDescription(''); setDate(todayStr); // 重置為今天
            };
            const handleManualEntrySubmit = () => {
                if (!manualDuration || !description) return;
                const durationSeconds = parseFloat(manualDuration) * 60;
                if (editingId) {
                    setEntries(entries.map(e => { if (e.id === editingId) { return { ...e, clientCode, sortOfWork, supervisor, description, durationSeconds, billableHours: calculateBillable(durationSeconds), date }; } return e; }));
                    cancelEdit();
                } else {
                    const newEntry = { id: Date.now(), startTime: new Date().toISOString(), endTime: new Date().toISOString(), supervisor, clientCode, sortOfWork, description, durationSeconds, billableHours: calculateBillable(durationSeconds), date: date, isManual: true };
                    setEntries([newEntry, ...entries]);
                    setManualDuration(''); setDescription(''); setDate(todayStr);
                }
            };
            const startEdit = (entry) => {
                if (timerStatus !== 'idle') { if(!confirm("正在計時中。建議先停止計時再編輯。仍要繼續嗎？")) return; }
                setClientCode(entry.clientCode || ''); setSortOfWork(entry.sortOfWork || ''); setSupervisor(entry.supervisor || ''); setDescription(entry.description || ''); setManualDuration(Math.round(entry.durationSeconds / 60).toString()); setDate(entry.date || todayStr); setEditingId(entry.id); window.scrollTo({ top: 0, behavior: 'smooth' });
            };
            const resumeEntry = (entry) => {
                if (timerStatus !== 'idle') { alert("請先停止或儲存當前計時"); return; }
                if (editingId) { if(!confirm("您正在編輯其他項目，確定要放棄編輯並開始計時嗎？")) return; cancelEdit(); }
                setClientCode(entry.clientCode || ''); setSortOfWork(entry.sortOfWork || ''); setSupervisor(entry.supervisor || ''); setDescription(entry.description || ''); setDate(entry.date || todayStr);
                const currentDuration = entry.durationSeconds || 0; accumulatedTimeRef.current = currentDuration * 1000; startTimeRef.current = Date.now(); setTimer(currentDuration); setResumingEntryId(entry.id); setTimerStatus('running'); window.scrollTo({ top: 0, behavior: 'smooth' });
            };
            const cancelEdit = () => { setClientCode(''); setSortOfWork(''); setSupervisor(''); setDescription(''); setManualDuration(''); setDate(todayStr); setEditingId(null); };
            const deleteEntry = (id) => { if(confirm('確定要刪除此紀錄嗎？')) { setEntries(entries.filter(e => e.id !== id)); if (editingId === id) cancelEdit(); } };
            const addTodo = (e) => { e.preventDefault(); if (!todoInput.trim()) return; setTodos([{ id: Date.now(), text: todoInput, clientCode: todoClient, completed: false, accumulatedSeconds: 0 }, ...todos]); setTodoInput(''); setTodoClient(''); };
            const toggleTodo = (id) => { setTodos(todos.map(t => t.id === id ? { ...t, completed: !t.completed } : t)); };
            const deleteTodo = (id) => { if(confirm('確定要刪除此待辦事項嗎？')) { setTodos(todos.filter(t => t.id !== id)); } };
            const loadTaskToTimer = (todo) => { if (timerStatus !== 'idle') { alert("請先停止或儲存當前計時"); return; } if (editingId) { if(!confirm("放棄編輯？")) return; cancelEdit(); } setClientCode(todo.clientCode || ''); setDescription(todo.text); setActiveTodoId(todo.id); window.scrollTo({ top: 0, behavior: 'smooth' }); };
            const startEditTodo = (todo) => { setEditingTodoId(todo.id); setEditTodoText(todo.text); setEditTodoClient(todo.clientCode || ''); };
            const cancelEditTodo = () => { setEditingTodoId(null); setEditTodoText(''); setEditTodoClient(''); };
            const saveEditTodo = (id) => { if (!editTodoText.trim()) return; setTodos(todos.map(t => t.id === id ? { ...t, text: editTodoText, clientCode: editTodoClient } : t)); cancelEditTodo(); };
            const formatAccumulated = (s) => s ? `${(s/3600).toFixed(1)}h` : '';
            const visibleTodos = todos.filter(t => showCompleted || !t.completed);
            const getFilteredEntries = () => { return entries.filter(e => { if (!exportStartDate && !exportEndDate) return true; if (exportStartDate && e.date < exportStartDate) return false; if (exportEndDate && e.date > exportEndDate) return false; return true; }).slice().reverse(); };
            const copyToClipboard = () => { const filtered = getFilteredEntries(); if (filtered.length === 0) { alert("選定的日期區間內沒有資料。"); return; } const content = filtered.map(e => `${e.clientCode||''}\t${e.date}\t${e.sortOfWork||''}\t${e.billableHours}\t${(e.description||'').replace(/\n/g, ' ')}\t${e.supervisor||''}`).join('\n'); const ta = document.createElement("textarea"); ta.value = content; document.body.appendChild(ta); ta.select(); document.execCommand('copy'); document.body.removeChild(ta); const btn = document.getElementById('copyBtn'); if(btn) { const orig = btn.innerHTML; btn.innerHTML = '已複製！'; setTimeout(() => btn.innerHTML = orig, 1500); } };
            const downloadCSV = () => { const filtered = getFilteredEntries(); if (filtered.length === 0) { alert("選定的日期區間內沒有資料。"); return; } const header = "Client Code,Date,Sort of Work,Hours (刻),General Work Description,Supervisor\n"; const content = filtered.map(e => `"${(e.clientCode||'').replace(/"/g, '""')}","${e.date}","${(e.sortOfWork||'').replace(/"/g, '""')}",${e.billableHours},"${(e.description||'').replace(/"/g, '""')}","${(e.supervisor||'').replace(/"/g, '""')}"`).join('\n'); const blob = new Blob(["\uFEFF" + header + content], { type: 'text/csv;charset=utf-8;' }); const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url; a.setAttribute('download', `Timesheet_${exportStartDate}_to_${exportEndDate}.csv`); document.body.appendChild(a); a.click(); document.body.removeChild(a); };
            const exportBackup = () => { const blob = new Blob([JSON.stringify({ entries, todos, date: new Date().toISOString() }, null, 2)], { type: 'application/json' }); const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url; a.setAttribute('download', `Backup_${new Date().toLocaleDateString('zh-TW').replace(/\//g,'')}.json`); document.body.appendChild(a); a.click(); document.body.removeChild(a); };
            const importBackup = (e) => { const file = e.target.files[0]; if (!file) return; const reader = new FileReader(); reader.onload = (ev) => { try { const data = JSON.parse(ev.target.result); if (data.entries && data.todos && confirm('將覆蓋目前資料，確定嗎？')) { setEntries(data.entries); setTodos(data.todos); alert('還原成功！'); } } catch (err) { alert('檔案錯誤'); } }; reader.readAsText(file); e.target.value = ''; };
            
            const syncToNotion = async () => {
                if (!webhookUrl) { alert("請先點擊右上角的設定 (⚙️) 按鈕，輸入 Webhook URL (或 Google Apps Script 網址)。"); setIsSettingsOpen(true); return; }
                if (entries.length === 0) { alert("目前沒有紀錄可同步。"); return; }
                if (!confirm(`即將傳送 ${entries.length} 筆資料。\n確定要繼續嗎？`)) return;
                setIsSyncing(true);
                try {
                    const response = await fetch(webhookUrl, { method: 'POST', headers: { 'Content-Type': 'text/plain;charset=utf-8' }, body: JSON.stringify({ entries: entries, syncedAt: new Date().toISOString() }) });
                    if (response.ok) { alert("✅ 資料發送成功！\n資料正在背景處理中。"); } else { alert(`❌ 發送失敗: ${response.statusText}`); }
                } catch (error) { console.error(error); alert("❌ 發生錯誤：" + error.message + "\n請檢查網址是否正確。"); } finally { setIsSyncing(false); }
            };

            const getDaysDifference = () => { if (!exportStartDate || !exportEndDate) return 1; const start = new Date(exportStartDate); const end = new Date(exportEndDate); const diffTime = end - start; const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)) + 1; return diffDays > 0 ? diffDays : 1; };
            const totalBillable = getFilteredEntries().reduce((acc, cur) => acc + parseFloat(cur.billableHours || 0), 0).toFixed(2);
            const targetHours = getDaysDifference() * 8;
            const progressPercentage = Math.min((totalBillable / targetHours) * 100, 100);

            return (
                <div className="min-h-screen pb-10">
                    <header className="bg-slate-900 text-white p-4 shadow-md sticky top-0 z-50">
                        <div className="max-w-[1400px] mx-auto flex justify-between items-center">
                            <div className="flex items-center space-x-2">
                                <Briefcase className="w-6 h-6 text-blue-400" />
                                <h1 className="text-xl font-bold tracking-wide">LegalTimekeeper</h1>
                            </div>
                            <div className="flex items-center gap-4">
                                <div className="text-sm text-slate-400 hidden sm:block">
                                    {new Date().toLocaleDateString('zh-TW')}
                                </div>
                                <button onClick={() => setIsSettingsOpen(true)} className="p-2 hover:bg-slate-800 rounded-full transition-colors flex items-center gap-2" title="設定">
                                    {isCloudConnected ? <span className="w-2 h-2 rounded-full bg-green-500 animate-pulse"></span> : null}
                                    <Settings className="w-5 h-5 text-slate-300 hover:text-white" />
                                </button>
                            </div>
                        </div>
                    </header>

                    {/* 設定 Modal */}
                    {isSettingsOpen && (
                        <div className="fixed inset-0 bg-black/50 z-[60] flex items-center justify-center p-4">
                            <div className="bg-white rounded-xl shadow-2xl p-6 max-w-lg w-full animate-[fadeIn_0.2s_ease-out] overflow-y-auto max-h-[90vh]">
                                <div className="flex justify-between items-center mb-4">
                                    <h3 className="text-lg font-bold text-slate-800 flex items-center gap-2">
                                        <Settings className="w-5 h-5" /> 系統設定
                                    </h3>
                                    <button onClick={() => setIsSettingsOpen(false)} className="text-slate-400 hover:text-slate-600"><X className="w-6 h-6" /></button>
                                </div>
                                
                                <div className="space-y-6">
                                    {/* Webhook Section */}
                                    <div className="p-4 bg-slate-50 rounded-lg border border-slate-100">
                                        <h4 className="font-bold text-slate-700 mb-2 flex items-center gap-2">
                                            <CloudLightning className="w-4 h-4 text-purple-600"/> Notion 同步 (單向)
                                        </h4>
                                        <label className="block text-xs font-medium text-slate-500 mb-1">Webhook URL (Google Apps Script / Make)</label>
                                        <input type="text" value={webhookUrl} onChange={(e) => setWebhookUrl(e.target.value)} placeholder="https://..." className="w-full px-3 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-purple-500 outline-none text-xs"/>
                                        <p className="text-[10px] text-slate-400 mt-1">將目前資料單向備份至 Notion 資料庫。</p>
                                    </div>

                                    {/* Cloud Sync Section */}
                                    <div className="p-4 bg-blue-50 rounded-lg border border-blue-100">
                                        <h4 className="font-bold text-slate-700 mb-2 flex items-center gap-2">
                                            <Database className="w-4 h-4 text-blue-600"/> 跨裝置同步 (雙向)
                                        </h4>
                                        <p className="text-xs text-blue-600 mb-3">若要在不同瀏覽器間同步，請在此輸入您的 Firebase 設定。</p>
                                        
                                        <div className="space-y-3">
                                            <div>
                                                <label className="block text-xs font-medium text-slate-500 mb-1">Sync ID (同步密碼)</label>
                                                <input type="text" value={syncId} onChange={(e) => setSyncId(e.target.value)} placeholder="自訂一組密碼，例如: my-law-firm-123" className="w-full px-3 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none text-xs"/>
                                            </div>
                                            <div>
                                                <label className="block text-xs font-medium text-slate-500 mb-1">Firebase Config (請直接貼上整段程式碼)</label>
                                                <textarea 
                                                    rows="6" 
                                                    value={firebaseConfig} 
                                                    onChange={(e) => setFirebaseConfig(e.target.value)} 
                                                    placeholder={`const firebaseConfig = {\n  apiKey: "...",\n  authDomain: "...",\n  ...\n};`} 
                                                    className="w-full px-3 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none text-xs font-mono"
                                                ></textarea>
                                            </div>
                                            <div className="flex flex-col gap-1 text-xs">
                                                <div className="flex items-center gap-2">
                                                    <span>狀態: </span>
                                                    {cloudStatus === 'offline' && <span className="text-slate-400">未連線 (請輸入設定)</span>}
                                                    {cloudStatus === 'connecting' && <span className="text-yellow-600 animate-pulse">連線中...</span>}
                                                    {cloudStatus === 'connected' && <span className="text-green-600 font-bold">● 已連線 (即時同步中)</span>}
                                                    {cloudStatus === 'error' && <span className="text-red-600">連線失敗</span>}
                                                </div>
                                                {cloudStatus === 'error' && cloudErrorMsg && (
                                                    <div className="text-red-500 bg-red-50 p-2 rounded mt-1">
                                                        {cloudErrorMsg}
                                                    </div>
                                                )}
                                            </div>
                                        </div>
                                    </div>

                                    <div className="flex justify-end pt-2">
                                        <button onClick={() => setIsSettingsOpen(false)} className="bg-slate-800 hover:bg-slate-700 text-white px-4 py-2 rounded-lg text-sm font-medium">關閉</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    )}

                    <main className="max-w-[1400px] mx-auto p-4 md:p-6 space-y-6">
                        
                        <div className="grid grid-cols-1 xl:grid-cols-12 gap-6">
                            {/* 左側：計時器 */}
                            <div className="xl:col-span-8 space-y-6">
                                <div className={`rounded-xl shadow-lg border overflow-hidden transition-colors ${editingId ? 'bg-amber-50 border-amber-300' : (resumingEntryId ? 'bg-blue-50 border-blue-300' : 'bg-white border-slate-200')}`}>
                                    <div className={`p-6 text-white flex flex-col md:flex-row justify-between items-center space-y-4 md:space-y-0 ${editingId ? 'bg-amber-600' : (resumingEntryId ? 'bg-blue-700' : 'bg-slate-800')}`}>
                                        <div className="flex flex-col">
                                            <span className={`text-xs uppercase tracking-wider mb-1 ${editingId ? 'text-amber-100' : (resumingEntryId ? 'text-blue-100' : 'text-slate-400')}`}>
                                                {editingId ? 'EDITING MODE' : (resumingEntryId ? 'RESUMING ENTRY' : (timerStatus === 'paused' ? 'Paused' : 'Duration'))}
                                            </span>
                                            <div className={`text-5xl font-mono font-bold tracking-wider ${editingId ? 'text-white opacity-50' : (timerStatus === 'paused' ? 'text-yellow-400' : (resumingEntryId ? 'text-white' : 'text-blue-400'))}`}>
                                                {formatTime(timer)}
                                            </div>
                                        </div>
                                        <div className="flex items-center space-x-4">
                                            {timerStatus === 'idle' && (
                                                <button onClick={startTimer} disabled={!!editingId} className={`flex items-center space-x-2 text-white px-8 py-3 rounded-full font-bold transition-all shadow-lg ${editingId ? 'bg-slate-400 cursor-not-allowed opacity-50' : 'bg-blue-600 hover:bg-blue-500 hover:scale-105 shadow-blue-900/50'}`}>
                                                    <Play className="w-5 h-5 fill-current" /><span>Start</span>
                                                </button>
                                            )}
                                            {timerStatus === 'running' && (
                                                <div className="flex space-x-3">
                                                    <button onClick={pauseTimer} className="flex items-center space-x-2 bg-yellow-500 hover:bg-yellow-400 text-slate-900 px-6 py-3 rounded-full font-bold transition-all"><Pause className="w-5 h-5 fill-current" /><span>Pause</span></button>
                                                    <button onClick={stopTimer} className="flex items-center space-x-2 bg-red-600 hover:bg-red-500 text-white px-6 py-3 rounded-full font-bold transition-all animate-pulse"><Square className="w-5 h-5 fill-current" /><span>Stop</span></button>
                                                </div>
                                            )}
                                            {timerStatus === 'paused' && (
                                                <div className="flex space-x-3">
                                                    <button onClick={resumeTimer} className="flex items-center space-x-2 bg-green-500 hover:bg-green-400 text-white px-6 py-3 rounded-full font-bold transition-all shadow-lg"><Play className="w-5 h-5 fill-current" /><span>Resume</span></button>
                                                    <button onClick={stopTimer} className="flex items-center space-x-2 bg-red-600 hover:bg-red-500 text-white px-6 py-3 rounded-full font-bold transition-all"><Square className="w-5 h-5 fill-current" /><span>Stop</span></button>
                                                </div>
                                            )}
                                        </div>
                                    </div>
                                    <div className={`p-6 grid grid-cols-1 md:grid-cols-12 gap-4 ${editingId ? 'bg-amber-50' : (resumingEntryId ? 'bg-blue-50' : 'bg-slate-50')}`}>
                                        {editingId && <div className="md:col-span-12 text-sm font-bold text-amber-700 mb-2 flex items-center gap-2"><Pencil className="w-4 h-4" /> 編輯模式</div>}
                                        {resumingEntryId && <div className="md:col-span-12 text-sm font-bold text-blue-700 mb-2 flex items-center gap-2"><Play className="w-4 h-4" /> 正在續行舊有項目 (時間將會累加)</div>}
                                        <div className="md:col-span-2"><label className="block text-xs font-semibold text-slate-500 mb-1">Date</label><input type="date" value={date} onChange={(e)=>setDate(e.target.value)} className="w-full px-3 py-2 bg-white border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none"/></div>
                                        <div className="md:col-span-2"><label className="block text-xs font-semibold text-slate-500 mb-1">Client Code</label><input type="text" value={clientCode} onChange={(e)=>setClientCode(e.target.value)} placeholder="Code" className="w-full px-3 py-2 bg-white border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none"/></div>
                                        <div className="md:col-span-3"><label className="block text-xs font-semibold text-slate-500 mb-1 flex items-center gap-1"><Tag className="w-3 h-3" /> Sort of Work</label><input type="text" value={sortOfWork} onChange={(e)=>setSortOfWork(e.target.value)} placeholder="e.g. RR, MT..." className="w-full px-3 py-2 bg-white border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none"/></div>
                                        <div className="md:col-span-2"><label className="block text-xs font-semibold text-slate-500 mb-1 flex items-center gap-1"><User className="w-3 h-3" /> Supervisor</label><input type="text" value={supervisor} onChange={(e)=>setSupervisor(e.target.value)} placeholder="Name" className="w-full px-3 py-2 bg-white border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none"/></div>
                                        <div className="md:col-span-3"><label className="block text-xs font-semibold text-slate-500 mb-1">{editingId?'Edit Time (Min)':'Manual (Min)'}</label><div className="flex space-x-2"><input type="number" value={manualDuration} onChange={(e)=>setManualDuration(e.target.value)} placeholder="Min" className="w-full px-3 py-2 bg-white border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none"/>{editingId?(<><button onClick={handleManualEntrySubmit} disabled={!manualDuration} className="bg-green-600 hover:bg-green-500 text-white p-2 rounded-lg disabled:opacity-50 transition-colors" title="儲存"><Save className="w-5 h-5"/></button><button onClick={cancelEdit} className="bg-slate-300 hover:bg-slate-400 text-slate-700 p-2 rounded-lg transition-colors" title="取消"><X className="w-5 h-5"/></button></>):(<button onClick={handleManualEntrySubmit} disabled={timerStatus!=='idle'||!manualDuration} className="bg-blue-100 hover:bg-blue-200 text-blue-700 p-2 rounded-lg disabled:opacity-50 transition-colors" title="新增"><Plus className="w-5 h-5"/></button>)}</div></div>
                                        <div className="md:col-span-12 md:row-start-2"><label className="block text-xs font-semibold text-slate-500 mb-1">General Work Description</label><input type="text" value={description} onChange={(e)=>setDescription(e.target.value)} placeholder="Details..." className="w-full px-3 py-2 bg-white border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none"/></div>
                                        <div className="md:col-span-12 md:row-start-3 flex flex-wrap gap-2 items-end pb-1">{quickDescriptions.map((desc,idx)=>(<button key={idx} onClick={()=>setDescription(desc)} className="text-[10px] bg-slate-200 hover:bg-slate-300 text-slate-600 px-2 py-1 rounded transition-colors">{desc.length>20?desc.substring(0,20)+'...':desc}</button>))}</div>
                                    </div>
                                </div>
                            </div>

                            {/* 右側：待辦清單 */}
                            <div className="xl:col-span-4 flex flex-col h-full min-h-[400px]">
                                <div className="bg-white rounded-xl shadow-lg border border-slate-200 flex-1 flex flex-col overflow-hidden">
                                    <div className="bg-slate-100 p-4 border-b border-slate-200 flex justify-between items-center">
                                        <h3 className="font-bold text-slate-700 flex items-center gap-2"><ListTodo className="w-5 h-5 text-blue-600"/> Task Queue</h3>
                                        <div className="flex items-center gap-2">
                                            <span className="text-xs text-slate-500 bg-white px-2 py-1 rounded-full border border-slate-200">{todos.filter(t=>!t.completed).length} Pending</span>
                                            <button onClick={() => setShowCompleted(!showCompleted)} className={`p-1.5 rounded-full border transition-colors ${showCompleted ? 'bg-blue-100 text-blue-600 border-blue-200' : 'bg-white text-slate-400 border-slate-200 hover:bg-slate-50'}`} title={showCompleted ? "隱藏已完成" : "顯示已完成"}>{showCompleted ? <Eye className="w-4 h-4"/> : <EyeOff className="w-4 h-4"/>}</button>
                                        </div>
                                    </div>
                                    <form onSubmit={addTodo} className="p-3 border-b border-slate-100 bg-slate-50/50"><div className="flex gap-2 mb-2"><input type="text" value={todoClient} onChange={(e)=>setTodoClient(e.target.value)} placeholder="Client (Opt)" className="w-1/3 px-2 py-1.5 text-xs bg-white border border-slate-300 rounded focus:ring-1 focus:ring-blue-500 outline-none"/><input type="text" value={todoInput} onChange={(e)=>setTodoInput(e.target.value)} placeholder="New task..." className="flex-1 px-2 py-1.5 text-sm bg-white border border-slate-300 rounded focus:ring-1 focus:ring-blue-500 outline-none"/></div><button type="submit" disabled={!todoInput.trim()} className="w-full bg-slate-800 text-white text-xs font-bold py-1.5 rounded hover:bg-slate-700 transition-colors disabled:opacity-50">Add Task</button></form>
                                    <div className="flex-1 overflow-y-auto p-2 space-y-2 max-h-[400px]">
                                        {visibleTodos.length === 0 && todos.length > 0 && !showCompleted && <div className="text-center text-xs text-slate-400 py-4 italic">已隱藏 {todos.filter(t=>t.completed).length} 個完成項目</div>}
                                        {visibleTodos.map(todo=>(
                                            <div key={todo.id} className={`group flex items-start gap-2 p-3 rounded-lg border transition-all ${todo.completed?'bg-slate-50 border-slate-100 opacity-60':'bg-white border-slate-200 hover:border-blue-300 hover:shadow-sm'} ${activeTodoId===todo.id?'ring-2 ring-blue-500 ring-offset-1 border-blue-500 bg-blue-50/50':''}`}>
                                                {editingTodoId === todo.id ? (
                                                    <React.Fragment>
                                                        <div className="w-full">
                                                            <div className="flex gap-2 mb-2">
                                                                <input type="text" value={editTodoClient} onChange={(e) => setEditTodoClient(e.target.value)} placeholder="Client" className="w-1/3 px-2 py-1 text-xs border rounded bg-white" />
                                                                <input type="text" value={editTodoText} onChange={(e) => setEditTodoText(e.target.value)} placeholder="Task" className="flex-1 px-2 py-1 text-sm border rounded bg-white" autoFocus />
                                                            </div>
                                                            <div className="flex justify-end gap-2">
                                                                <button onClick={() => saveEditTodo(todo.id)} className="p-1 bg-green-100 text-green-700 rounded hover:bg-green-200"><Save className="w-4 h-4" /></button>
                                                                <button onClick={cancelEditTodo} className="p-1 bg-slate-100 text-slate-600 rounded hover:bg-slate-200"><X className="w-4 h-4" /></button>
                                                            </div>
                                                        </div>
                                                    </React.Fragment>
                                                ) : (
                                                    <React.Fragment>
                                                        <button onClick={()=>toggleTodo(todo.id)} className={`mt-0.5 min-w-[16px] h-4 rounded border flex items-center justify-center ${todo.completed?'bg-green-500 border-green-500 text-white':'border-slate-300 hover:border-blue-400'}`}>{todo.completed&&<CheckSquare className="w-3 h-3"/>}</button>
                                                        <div className="flex-1 min-w-0">
                                                            <div className="flex justify-between items-center mb-0.5">
                                                                {todo.clientCode&&(<div className="text-[10px] font-mono text-slate-500">{todo.clientCode}</div>)}
                                                                {todo.accumulatedSeconds>0&&(<div className="flex items-center gap-1 text-[10px] font-bold text-orange-600 bg-orange-100 px-1.5 py-0.5 rounded-full whitespace-nowrap"><History className="w-3 h-3"/>{formatAccumulated(todo.accumulatedSeconds)}</div>)}
                                                            </div>
                                                            <div className={`text-sm ${todo.completed?'line-through text-slate-400':'text-slate-800'}`}>{todo.text}</div>
                                                            {activeTodoId===todo.id&&timerStatus==='running'&&(<div className="text-[10px] text-blue-600 animate-pulse font-medium mt-1">● Timing now...</div>)}
                                                        </div>
                                                        <div className="flex flex-col gap-1 opacity-100 sm:opacity-0 sm:group-hover:opacity-100 transition-opacity">
                                                            {!todo.completed&&(<button onClick={()=>loadTaskToTimer(todo)} disabled={timerStatus!=='idle'} className="p-1.5 bg-blue-50 text-blue-600 rounded hover:bg-blue-600 hover:text-white transition-colors disabled:opacity-30" title="Start"><Play className="w-4 h-4"/></button>)}
                                                            <button onClick={() => startEditTodo(todo)} className="p-1.5 text-slate-400 hover:text-blue-500 hover:bg-blue-50 rounded transition-colors" title="編輯"><Pencil className="w-4 h-4" /></button>
                                                            <button onClick={()=>deleteTodo(todo.id)} className="p-1.5 text-slate-300 hover:text-red-500 transition-colors"><Trash2 className="w-4 h-4"/></button>
                                                        </div>
                                                    </React.Fragment>
                                                )}
                                            </div>
                                        ))}
                                    </div>
                                </div>
                            </div>
                        </div>

                        {/* 下半部：列表與統計區域 */}
                        <div className="grid grid-cols-1 lg:grid-cols-4 gap-6">
                            <div className="lg:col-span-3 space-y-4">
                                <div className="flex justify-between items-end">
                                    <h2 className="text-lg font-bold text-slate-700 flex items-center gap-2"><FileText className="w-5 h-5"/> Timesheet Entries</h2>
                                    {entries.length>0&&(<button onClick={()=>{if(confirm('Clear all entries?'))setEntries([])}} className="text-xs text-red-400 hover:text-red-600 underline">Clear All</button>)}
                                </div>
                                <div className="bg-white rounded-xl border border-slate-200 shadow-sm overflow-hidden">
                                    <div className="overflow-x-auto">
                                        <table className="w-full text-sm text-left">
                                            <thead className="bg-slate-100 text-slate-600 font-semibold border-b border-slate-200"><tr><th className="px-4 py-3 whitespace-nowrap">Date</th><th className="px-4 py-3 whitespace-nowrap">Client Code</th><th className="px-4 py-3 whitespace-nowrap">Sort of Work</th><th className="px-4 py-3 whitespace-nowrap">Hours (刻)</th><th className="px-4 py-3 w-1/3">Description</th><th className="px-4 py-3 whitespace-nowrap">Supervisor</th><th className="px-4 py-3 text-right">Actions</th></tr></thead>
                                            <tbody className="divide-y divide-slate-100">{entries.length===0?(<tr><td colSpan="7" className="p-8 text-center text-slate-400 italic">No entries yet.</td></tr>):(entries.map((entry)=>(<tr key={entry.id} className={`transition-colors group ${editingId===entry.id?'bg-amber-50':(resumingEntryId===entry.id?'bg-blue-50':'hover:bg-slate-50')}`}><td className="px-4 py-3 text-slate-500 whitespace-nowrap">{entry.date}</td><td className="px-4 py-3 font-mono text-blue-600">{entry.clientCode}</td><td className="px-4 py-3 text-slate-700"><span className="bg-slate-100 px-2 py-1 rounded text-xs border border-slate-200">{entry.sortOfWork}</span></td><td className="px-4 py-3 font-bold text-slate-800">{entry.billableHours}</td><td className="px-4 py-3 text-slate-600 truncate max-w-xs">{entry.description}</td><td className="px-4 py-3 text-slate-700">{entry.supervisor}</td><td className="px-4 py-3 text-right"><div className="flex items-center justify-end gap-2"><button onClick={()=>resumeEntry(entry)} disabled={timerStatus!=='idle'} className={`p-1.5 rounded transition-colors ${resumingEntryId===entry.id?'bg-blue-600 text-white':'text-slate-300 hover:text-blue-600 hover:bg-blue-50 disabled:opacity-30'}`} title="續行工作 (累加時間)"><Play className="w-4 h-4"/></button><button onClick={()=>startEdit(entry)} disabled={timerStatus!=='idle'} className={`p-1.5 rounded transition-colors ${editingId===entry.id?'bg-amber-200 text-amber-800':'text-slate-300 hover:text-amber-600 hover:bg-amber-50 disabled:opacity-30'}`} title="編輯"><Pencil className="w-4 h-4"/></button><button onClick={()=>deleteEntry(entry.id)} className="p-1.5 text-slate-300 hover:text-red-500 hover:bg-red-50 rounded transition-colors" title="刪除"><Trash2 className="w-4 h-4"/></button></div></td></tr>)))}</tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>

                            <div className="space-y-6">
                                <div className="bg-white p-6 rounded-xl border border-slate-200 shadow-sm">
                                    <div className="flex justify-between items-start mb-4">
                                        <h3 className="text-xs font-bold text-slate-400 uppercase tracking-wider">Total Hours (刻)</h3>
                                    </div>
                                    <div className="flex gap-2 mb-4 bg-slate-50 p-2 rounded-lg border border-slate-100">
                                        <div className="flex-1">
                                            <label className="text-[10px] text-slate-400 block mb-1">From</label>
                                            <input type="date" value={exportStartDate} onChange={(e)=>setExportStartDate(e.target.value)} className="w-full text-xs px-2 py-1 border border-slate-200 rounded"/>
                                        </div>
                                        <div className="flex-1">
                                            <label className="text-[10px] text-slate-400 block mb-1">To</label>
                                            <input type="date" value={exportEndDate} onChange={(e)=>setExportEndDate(e.target.value)} className="w-full text-xs px-2 py-1 border border-slate-200 rounded"/>
                                        </div>
                                    </div>
                                    <div className="text-4xl font-bold text-slate-800 mb-2">{totalBillable}</div>
                                    <div className="w-full bg-slate-100 rounded-full h-1.5 mb-2"><div className="bg-green-500 h-1.5 rounded-full transition-all duration-500" style={{width:`${progressPercentage}%`}}></div></div>
                                    <p className="text-xs text-slate-400 text-right">Target: {targetHours} hrs ({getDaysDifference()} days)</p>
                                </div>

                                <div className="bg-white p-6 rounded-xl border border-slate-200 shadow-sm space-y-3">
                                    <h3 className="text-xs font-bold text-slate-400 uppercase tracking-wider mb-2">Sync & Actions</h3>
                                    <button onClick={syncToNotion} disabled={entries.length === 0 || isSyncing} className="w-full flex justify-center items-center gap-2 bg-gradient-to-r from-purple-600 to-blue-600 hover:from-purple-700 hover:to-blue-700 text-white py-2.5 rounded-lg text-sm font-bold transition-all shadow-md disabled:opacity-50 disabled:shadow-none" title="將列表資料同步到 Notion (需設定 Webhook)"><CloudLightning className={`w-4 h-4 ${isSyncing ? 'animate-pulse' : ''}`} />{isSyncing ? 'Syncing...' : 'Sync to Notion'}</button>
                                    <div className="grid grid-cols-2 gap-2 pb-3 border-b border-slate-100 pt-2">
                                        <button onClick={exportBackup} disabled={entries.length===0&&todos.length===0} className="flex flex-col justify-center items-center p-2 bg-blue-50 hover:bg-blue-100 text-blue-700 rounded-lg text-xs font-medium transition-colors disabled:opacity-50"><Save className="w-5 h-5 mb-1"/>Backup JSON</button>
                                        <div className="relative"><input type="file" accept=".json" onChange={importBackup} ref={fileInputRef} className="hidden"/><button onClick={()=>fileInputRef.current?.click()} className="w-full h-full flex flex-col justify-center items-center p-2 bg-slate-50 hover:bg-slate-100 text-slate-700 rounded-lg text-xs font-medium transition-colors"><Upload className="w-5 h-5 mb-1"/>Restore JSON</button></div>
                                    </div>
                                    <h3 className="text-xs font-bold text-slate-400 uppercase tracking-wider mt-2 mb-2 flex items-center gap-2"><Calendar className="w-3 h-3"/> Export List</h3>
                                    <p className="text-[10px] text-slate-400 mb-2">Based on date range selected above.</p>
                                    <button id="copyBtn" onClick={copyToClipboard} disabled={entries.length===0} className="w-full flex justify-center items-center gap-2 bg-slate-800 hover:bg-slate-700 text-white py-2.5 rounded-lg text-sm font-medium transition-colors disabled:opacity-50"><Copy className="w-4 h-4"/>Copy for Excel</button>
                                    <button onClick={downloadCSV} disabled={entries.length===0} className="w-full flex justify-center items-center gap-2 bg-white hover:bg-slate-50 text-slate-700 border border-slate-300 py-2.5 rounded-lg text-sm font-medium transition-colors disabled:opacity-50"><Download className="w-4 h-4"/>Download CSV</button>
                                </div>
                            </div>
                        </div>
                    </main>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<LegalTimesheet />);
    </script>
</body>
</html>